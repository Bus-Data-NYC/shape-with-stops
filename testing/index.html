<!DOCTYPE HTML>
<html>
  <head>
    <title>Length measure testing</title>

  <!-- css libraries -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css">
  
  <!-- js toolset -->
  <script src="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

  <!-- leaflet toolkit -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster-src.js"></script>
  
  </head>

  <style>
    .map {
      width: 100%;
      height: 600px;
    }
    .btn, .input-group-addon, .form-control {
      border-radius: 0px;
    }
    .leaflet-cluster-anim .leaflet-marker-icon, .leaflet-cluster-anim .leaflet-marker-shadow {
      -webkit-transition: -webkit-transform 0.3s ease-out, opacity 0.3s ease-in;
      -moz-transition: -moz-transform 0.3s ease-out, opacity 0.3s ease-in;
      -o-transition: -o-transform 0.3s ease-out, opacity 0.3s ease-in;
      transition: transform 0.3s ease-out, opacity 0.3s ease-in;
    }
    .marker-cluster-small {
      background-color: rgba(181, 226, 140, 0.6);
    }
    .marker-cluster-small div {
      background-color: rgba(110, 204, 57, 0.6);
    }

    .marker-cluster-medium {
      background-color: rgba(241, 211, 87, 0.6);
    }
    .marker-cluster-medium div {
      background-color: rgba(240, 194, 12, 0.6);
    }

    .marker-cluster-large {
      background-color: rgba(253, 156, 115, 0.6);
    }
    .marker-cluster-large div {
      background-color: rgba(241, 128, 23, 0.6);
    }

      /* IE 6-8 fallback colors */
    .leaflet-oldie .marker-cluster-small {
      background-color: rgb(181, 226, 140);
    }
    .leaflet-oldie .marker-cluster-small div {
      background-color: rgb(110, 204, 57);
    }

    .leaflet-oldie .marker-cluster-medium {
      background-color: rgb(241, 211, 87);
    }
    .leaflet-oldie .marker-cluster-medium div {
      background-color: rgb(240, 194, 12);
    }

    .leaflet-oldie .marker-cluster-large {
      background-color: rgb(253, 156, 115);
    }
    .leaflet-oldie .marker-cluster-large div {
      background-color: rgb(241, 128, 23);
    }

    .marker-cluster {
      background-clip: padding-box;
      border-radius: 20px;
    }
    .marker-cluster div {
      width: 30px;
      height: 30px;
      margin-left: 5px;
      margin-top: 5px;

      text-align: center;
      border-radius: 15px;
      font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
    }
    .marker-cluster span {
      line-height: 30px;
    }

  </style>
  
  <body>
    <div class="container">
      
      <h2>
        Length Analysis
        <br>
        <small>
          Stop Seq #10: <span id="seq10">None</span>m
          <br>
          Stop Seq #11: <span id="seq11">- </span>m
        </small>
      </h2>


      <div class="row">
        <div class="col-xs-12">
          <div class="map" id="map">
          </div>
        </div>
      </div>

    </div>
  </body>

  <script type="text/javascript">

    // global for stops
    var map;
    var markers;
    var route;
    var stops;
    var drawLines = {"10": [], "11": []};

    map = new L.map('map', {
      center: new L.LatLng(40.82151, -73.82177),
      zoom: 19,
      layers: []
    });
    L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png').addTo(map);

    $.get('exampleShapeWithBackwardsResults.csv')
    .done(function (data) {
      route = parseCSV(data);
    }).complete(function () {
      if (route !== undefined) {
        L.geoJson(route, {style: {weight: 2}}).addTo(map);

        $.get('issueTripExample.json')
        .done(function (data) {
          var issuePoints = [];
          data.forEach(function (stop) {
            var marker = L.marker(stop.loc).bindPopup("Seq. #: " + String(stop.seq) + " \nDist: " + String(stop.d + " meters")).addTo(map);

            if (stop.seq == "10" || stop.seq == "11") {
              marker.properties = stop.seq;
              issuePoints.push(marker)
            };
          });
          walkThroughAlgorithm(issuePoints);
        });

      }
    });


    
    function parseCSV(data) {
      data = data.split('\n');
      data.shift();
      data = data.map(function (row) {
        row = row.split(',');
        return [Number(row[1]), Number(row[0])];
      });
      data = data.filter(function (row, i) {
        if (isNaN(row[0]) || isNaN(row[1])) {
          return false;
        } else {
          L.circle([row[1], row[0]], 2, {color: "red", weight: 1}).bindPopup("Circle Index: " + String(i)).addTo(map);
          return true;
        }
      })
      var geojson = {
        "type": "LineString",
        "coordinates": data
      };
      return geojson;
    };

    function walkThroughAlgorithm (issuePoints) {
      issuePoints.forEach(function (issue, issue_i) {
        issPt = [issue._latlng.lat, issue._latlng.lng];
        route.coordinates.forEach(function (pt, i) {
          if (i > 44 && i < 53) {
            var geojson = {
              "type": "LineString",
              "coordinates": [[issPt[1], issPt[0]], pt]
            };
            var style = {
              "color": "red",
              "weight": 1,
            };
            drawLines[issue.properties].push(L.geoJson(geojson, {style: style}));
          }
        });
      });
      animateLines();
    };

    function animateLines () {
      var currDrawn = {a: null, b: null};
      draw("10");

      function draw (mrkr) {
        console.log(mrkr, drawLines[mrkr])
        var a = drawLines[mrkr].shift();
        var b = drawLines[mrkr].shift();
        if (currDrawn.a !== null && currDrawn.b !== null) {
          map.removeLayer(currDrawn.a);
          map.removeLayer(currDrawn.b);
        }
        if (b == undefined) {
          if (mrkr == "10") {
            draw("11")
          } else {
            // we are done
            console.log("Done")
          }
        } else {
          // first pt is always the Issue pt
          a_ll = null;
          a.eachLayer(function (l) {
            a_ll = l._latlngs;
          });
          a.addTo(map);

          b_ll = null;
          b.eachLayer(function (l) {
            b_ll = l._latlngs;
          });
          b.addTo(map);

          var distA = hvrsn([a_ll[0].lat, a_ll[0].lng], [a_ll[1].lat, a_ll[1].lng]);
          var distB = hvrsn([b_ll[0].lat, b_ll[0].lng], [b_ll[1].lat, b_ll[1].lng]);
          var dist = distA + distB;


          $("#seq" + mrkr)[0].innerText = dist.toFixed(2);

          // update global vars w/ latest
          currDrawn.a = a;
          currDrawn.b = b;

          setTimeout(function () { draw(mrkr); }, 2000);
        }
        
      }

    };
    
    function hvrsn (ll1, ll2) {
      var dlat = ll2[0] - ll1[0],
          dlon = ll2[1] - ll1[1],
          erad = 6369087,
          alpha = dlat/2,
          beta = dlon/2,

          a = Math.sin(deg2rad(alpha)) * 
              Math.sin(deg2rad(alpha)) + 
              Math.cos(deg2rad(ll1[0])) * 
              Math.cos(deg2rad(ll2[0])) * 
              Math.sin(deg2rad(beta)) * 
              Math.sin(deg2rad(beta)),
          c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)),
          dist =  erad * c;
      return Number(dist.toFixed(6));
    };

    function deg2rad (d) {
      return (d * (Math.PI/180));
    };


  </script>
</html>




